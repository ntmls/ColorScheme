<html>
    <head>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://code.jquery.com/jquery-2.0.1.js"></script>
        <script src="http://underscorejs.org/underscore-min.js"></script>
        <script src="ColorScheme.js"></script>
    </head>
    <body>
        <input type="file" id="file" name="file" />
        <br>
        <canvas id="original-image"  width="50" height="50"></canvas>
        <p>
        <input type="number" name="cluster-count" id="cluster-count" min="2" max="256" value="16" />
        <input type="button" id="go" name="go" value="Go" onClick="execute()" />
        </p>
        <br>
        <svg id="clusters-svg" width="200" height="200"></svg>
        <br>
        <canvas id="quantized-image"  width="50" height="50"></canvas>

        <script>

            // --------- Load a file -----------------

            $('#file').on('change', fileChange);

            var clusters,
                originalImageData;

            function fileChange(e) {
                try {
                    var file = e.target.files[0];
                    var reader = new FileReader();
                    reader.onload = readFile;
                    reader.readAsDataURL(file);
                } catch(ex) {
                    alert(ex.line);
                }
            }

            function readFile(e) {
                var pic = new Image();
                var canvas = $('#original-image')[0];
                pic.src = e.target.result;
                var scale = getScale(pic.width, pic.height, 640, 640);
                canvas.width = pic.width * scale;
                canvas.height = pic.height * scale;
                ctx = canvas.getContext('2d');
                ctx.drawImage(pic,
                    0, 0, pic.width, pic.height,
                    0, 0, pic.width * scale, pic.height * scale);
                originalImageData = ctx.getImageData(0, 0, pic.width * scale, pic.height * scale);
            }

            function getScale(sWidth, sHeight, tWidth, tHeight) {
                var scale = tWidth / sWidth;
                if (sHeight * scale > tHeight) {
                    scale = tHeight / sHeight;
                }
                return scale;
            }

            // ---------- execute -----------------

            function execute() {
                try {
                    var count = document.getElementById('cluster-count').value;
                    clusters = ColorScheme.clusterColors(originalImageData.data, count);
                    renderCircles();
                    renderQuantized(originalImageData, clusters);
                } catch(ex) {
                    alert(ex.message);
                }
            }


            //----------------- render clusters -----------------

            function renderCircles() {
                var pack = d3.layout.pack()
                    .size([200, 200]);

                var data = _.map(clusters, function(d) {
                    return {
                        name: d.name,
                        value: d.count,
                        more: d
                    };
                });

                var root = {
                    name: 'root',
                    value: 1,
                    children: data
                }

                var nodes = pack(root);

                d3.select('body').append('br');
                var svg = d3.select('body').select('#clusters-svg')
                    .attr('width', 200)
                    .attr('height', 200);

                var circles = svg.selectAll('circle').data(nodes);
                circles.enter().append('circle');
                circles.attr('cx', function(d) { return d.x; })
                    .attr('cy', function(d) { return d.y; })
                    .attr('r', function(d) { return d.r; })
                    .style('fill', fillColorRule)
                    .style('stroke', 'black');
                circles.exit().remove();
            }

            function fillColorRule(d) {
                if (d.depth == 0) {
                    return 'none';
                } else {
                    return 'rgb(' + d.more.red + ',' + d.more.green + ',' + d.more.blue + ')';
                };
            }

            // -------- render quantized image ---------

            function renderQuantized(originalImageData, clusters) {
                var original = $('#original-image')[0];
                var canvas = $('#quantized-image')[0];
                var bytes = originalImageData.data;
                var cluster;
                canvas.width = original.width;
                canvas.height = original.height;
                var ctx = canvas.getContext('2d');
                var imageData = ctx.createImageData(originalImageData.width, originalImageData.height)
                for (var i = 0; i < bytes.length; i = i + 4) {
                    c = ColorScheme.findNearestCluster(bytes[i], bytes[i+1], bytes[i+2], clusters);
                    imageData.data[i] = c.red;
                    imageData.data[i+1] = c.green;
                    imageData.data[i+2] = c.blue;
                    imageData.data[i+3] = bytes[i+3];
                }
                ctx.putImageData(imageData, 0, 0, 0, 0, canvas.width, canvas.height);
            }

        </script>

    </body>
</html
